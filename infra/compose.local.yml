name: quizbee-local

services:
  # APPS
  api:
    build:
      context: .
      dockerfile: ../apps/api/Dockerfile.local
    env_file:
      - ../envs/.env
    volumes:
      - uv-cache:/root/.cache/uv
      - ../:/repo
      - /repo/apps/api/.venv
    ports:
      - "8000:8000"

  # worker:
  #   build:
  #     context: .
  #     dockerfile: apps/worker/Dockerfile.local
  #   env_file:
  #     - ../envs/.env
  #   volumes:
  #     - ../apps/worker/src:/app/src
  #   command: ["uv", "run", "python", "-m", "worker"]

  web:
    build:
      context: .
      dockerfile: ../apps/web/Dockerfile.local
    env_file:
      - ../envs/.env
    environment:
      - CI=true
      - CHOKIDAR_USEPOLLING=1
    volumes:
      - ../:/repo
      - pnpm-store:/pnpm
      - /repo/node_modules
      - /repo/apps/web/node_modules
    working_dir: /repo
    ports:
      - "4321:4321"

  app:
    build:
      context: .
      dockerfile: ../apps/app/Dockerfile.local
    environment:
      - CI=true
      - CHOKIDAR_USEPOLLING=1
    env_file:
      - ../envs/.env
    volumes:
      - ../:/repo
      - pnpm-store:/pnpm
      - /repo/node_modules
      - /repo/apps/app/node_modules
    working_dir: /repo
    ports:
      - "5173:5173"

  # INFRA
  pb:
    build:
      context: .
      dockerfile: ./pb/Dockerfile.local
    env_file:
      - ../envs/.env
    volumes:
      - ./pb/pb_data:/pb/pb_data
      - ./pb/pb_migrations:/pb/pb_migrations:ro
      - ./pb/pb_hooks:/pb/pb_hooks:ro
    ports:
      - "8090:8090"

  meili:
    image: getmeili/meilisearch:latest
    ports:
      - "7700:7700"
    volumes:
      - ./meilisearch/data:/meili_data
    env_file:
      - ../envs/.env

  dragonfly:
    image: docker.dragonflydb.io/dragonflydb/dragonfly:latest
    ports:
      - "6379:6379"
    volumes:
      - ./dragonfly/data:/data
    env_file:
      - ../envs/.env

volumes:
  pnpm-store:
  uv-cache:
