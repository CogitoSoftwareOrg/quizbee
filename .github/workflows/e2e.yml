name: E2E Tests

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]

concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: tests/e2e/package-lock.json

      - name: Install deps
        working-directory: tests/e2e
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('tests/e2e/package-lock.json') }}

      - name: Install Playwright browsers
        working-directory: tests/e2e
        run: npx playwright install --with-deps

      - name: Compute BASE URL
        id: url
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            pr="${{ github.event.pull_request.number }}"
            root="qa.quizbee.academy"
            appUrl="https://${pr}-${root}"
            
          else
            url="https://qa.quizbee.academy"
          fi
          echo "BASE_URL=$url" | tee -a "$GITHUB_OUTPUT"

      - name: Wait for readiness
        shell: bash
        env:
          BASE_URL: ${{ steps.url.outputs.BASE_URL }}
        run: |
          set -euo pipefail
          echo "Waiting for: $BASE_URL"
          urls=(
            "$BASE_URL/readyz"
            "$BASE_URL/api/readyz"
          )
          max_attempts=120
          sleep_s=3
          for u in "${urls[@]}"; do
            echo "::group::Wait $u"
            ok=0
            for i in $(seq 1 $max_attempts); do
              code=$(curl -s -o /dev/null -w "%{http_code}" "$u" || true)
              if [[ "$code" == "200" ]]; then ok=1; break; fi
              echo "Attempt $i/$max_attempts: $u -> $code"; sleep $sleep_s
            done
            if [[ $ok -eq 0 ]]; then
              echo "ERROR: $u is not ready"
              curl -sv "$BASE_URL" || true
              exit 1
            fi
            echo "::endgroup::"
          done
          echo "All readiness checks passed."

      - name: Run E2E (smoke)
        working-directory: tests/e2e
        env:
          PREVIEW_URL: ${{ steps.url.outputs.BASE_URL }}
          BASE_URL: ${{ steps.url.outputs.BASE_URL }}
        run: npm test -- --grep @smoke

      - name: Run E2E (full)
        if: ${{ success() }}
        working-directory: tests/e2e
        env:
          PREVIEW_URL: ${{ steps.url.outputs.BASE_URL }}
          BASE_URL: ${{ steps.url.outputs.BASE_URL }}
        run: npm test

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: tests/e2e/playwright-report
